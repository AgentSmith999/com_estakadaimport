<?php
namespace Joomla\Component\Estakadaimport\Site\Controller;

defined('_JEXEC') or die;

use Joomla\CMS\MVC\Controller\BaseController;
use Joomla\CMS\Factory;

class ExportController extends BaseController
{
    public function display($cachable = false, $urlparams = array())
    {
        $profileId = $this->input->getInt('export_profile', 0);
        $selectedManufacturer = $app->input->getInt('manufacturer', 0);
        $model = $this->getModel('Export');
        
        try {
            $view = $this->getView('Export', 'html');
            $view->setModel($model, true);
            
            // Загружаем полные данные для первоначального отображения
            $data = $model->getDisplayData($profileId, $selectedManufacturer);
            $view->data = $data;
            
            // Передаем все необходимые переменные
            $view->items = $data['products'] ?? [];
            $view->fixed_headers = $data['fixedHeaders'] ?? [];
            $view->product_names = $data['names'] ?? [];
            $view->product_skus = $data['product_skus'] ?? [];
            $view->product_categories = $data['categories'] ?? [];
            $view->product_manufacturers = $data['manufacturers'] ?? [];
            $view->product_prices = $data['prices'] ?? [];
            $view->product_images = $data['images'] ?? [];
            $view->all_custom_values = $data['customValues'] ?? [];
            
            // $view->virtuemart_custom_ids = $data['customFields'] ?? [];
            $view->custom_titles = array_column($data['customFields'] ?? [], 'custom_title');
            $view->virtuemart_custom_ids = array_column($data['customFields'] ?? [], 'virtuemart_custom_id');
            
            // $view->universal_custom_ids = $data['universalFields'] ?? [];
            $view->universal_custom_titles = array_column($data['universalFields'] ?? [], 'custom_title');
            $view->universal_custom_ids = array_column($data['universalFields'] ?? [], 'virtuemart_custom_id');

            $view->display();
        } catch (\Exception $e) {
            Factory::getApplication()->enqueueMessage($e->getMessage(), 'error');
            $this->setRedirect('index.php?option=com_estakadaimport&view=export');
        }
    }

    /**
     * AJAX-метод для загрузки таблицы
     * Доступ: index.php?option=com_estakadaimport&task=export.loadTable&format=raw&profile=ID
     */
    public function loadTable()
    {
        $app = Factory::getApplication();
        $profileId = $app->input->getInt('profile', 0);
        $selectedManufacturer = $app->input->getInt('manufacturer', 0);
        
        try {
            $model = $this->getModel('Export');
            $data = $model->getDisplayData($profileId, $selectedManufacturer);

            // Очищаем буферы
            while (ob_get_level()) {
                ob_end_clean();
            }

            // Устанавливаем заголовки
            header('Content-Type: text/html; charset=utf-8');
            
            // Получаем View
            $view = $this->getView('Export', 'html');
            $view->setLayout('default_table');
            $view->setModel($model, true);
            
            // Передаем ВСЕ необходимые данные
            $view->items = $data['products'] ?? [];
            $view->fixed_headers = $data['fixedHeaders'] ?? [];
            $view->product_names = $data['names'] ?? [];
            $view->product_categories = $data['categories'] ?? [];
            $view->product_manufacturers = $data['manufacturers'] ?? [];
            $view->product_prices = $data['prices'] ?? [];
            $view->product_images = $data['images'] ?? [];
            $view->all_custom_values = $data['customValues'] ?? [];
            $view->product_skus = $data['product_skus'] ?? [];
            
            // Передаем ID товаров
            $view->product_ids = array_column($data['products'] ?? [], 'virtuemart_product_id');
            
            // Передаем заголовки для кастомных полей
            $view->custom_titles = array_column($data['customFields'] ?? [], 'custom_title');
            $view->virtuemart_custom_ids = array_column($data['customFields'] ?? [], 'virtuemart_custom_id');
            
            $view->universal_custom_titles = array_column($data['universalFields'] ?? [], 'custom_title');
            $view->universal_custom_ids = array_column($data['universalFields'] ?? [], 'virtuemart_custom_id');
            
            // Выводим ТОЛЬКО HTML таблицы
            echo $view->loadTemplate();
            
        } catch (Exception $e) {
            // Очищаем буферы и выводим ошибку
            while (ob_get_level()) {
                ob_end_clean();
            }
            header('Content-Type: text/html; charset=utf-8');
            echo '<div class="alert alert-danger">Ошибка: ' . $e->getMessage() . '</div>';
        }
        
        $app->close();
    }
}